{
  "rules": {
    // Deny all access by default - explicit permissions only
    ".read": false,
    ".write": false,
    
    // User profiles - users can only access their own data
    "users": {
      "$uid": {
        ".read": "$uid === auth.uid && auth != null && auth.token.email_verified == true",
        ".write": "$uid === auth.uid && auth != null && auth.token.email_verified == true",
        ".validate": "newData.hasChildren(['email', 'createdAt']) && newData.child('email').val() === auth.token.email"
      }
    },
    
    // Appointments - enhanced security
    "appointments": {
      "$appointmentId": {
        ".read": "auth != null && auth.token.email_verified == true && (data.child('userId').val() === auth.uid || data.child('doctorId').val() === auth.uid || auth.token.admin == true)",
        ".write": "auth != null && auth.token.email_verified == true && (data.child('userId').val() === auth.uid || newData.child('userId').val() === auth.uid || auth.token.admin == true)",
        ".validate": "newData.hasChildren(['userId', 'doctorId', 'date', 'time', 'status']) && newData.child('userId').val() === auth.uid"
      }
    },
    
    // Doctors information - read-only for authenticated users, admin write access
    "doctors": {
      ".read": "auth != null && auth.token.email_verified == true",
      ".write": "auth != null && auth.token.email_verified == true && auth.token.admin == true",
      "$doctorId": {
        ".validate": "newData.hasChildren(['name', 'specialization', 'verified']) && newData.child('verified').val() == true"
      }
    },
    
    // Prescriptions - strict user isolation
    "prescriptions": {
      "$uid": {
        ".read": "$uid === auth.uid && auth != null && auth.token.email_verified == true",
        ".write": "($uid === auth.uid && auth != null && auth.token.email_verified == true) || (auth.token.admin == true && auth.token.email_verified == true)",
        ".validate": "newData.hasChildren(['patientId', 'doctorId', 'createdAt']) && newData.child('patientId').val() === $uid"
      }
    },
    
    // Messages - enhanced chat security
    "messages": {
      "$chatId": {
        ".read": "auth != null && auth.token.email_verified == true && (data.child('senderId').val() === auth.uid || data.child('receiverId').val() === auth.uid)",
        ".write": "auth != null && auth.token.email_verified == true && (newData.child('senderId').val() === auth.uid || data.child('senderId').val() === auth.uid)",
        ".validate": "newData.hasChildren(['senderId', 'receiverId', 'message', 'timestamp']) && newData.child('senderId').val() === auth.uid"
      }
    },
    
    // System metadata - admin only
    "system": {
      ".read": "auth != null && auth.token.admin == true",
      ".write": "auth != null && auth.token.admin == true"
    }
  }
}
